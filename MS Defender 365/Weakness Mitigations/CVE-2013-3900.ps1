<# remediation v3 #>
 # CVE-2013-3900
 #functions
function New-Key {
	param($Path, $Name)
	New-Item -path $Path -Name $Name -ea SilentlyContinue | Out-Null
}
function New-RegItem{
	param($Path, $Name, $PropertyType,$Value)
	New-ItemProperty -Path $Path -Name $Name -PropertyType $PropertyType -Value $Value -ea SilentlyContinue | Out-null
}
#path
$path0 = 'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config'
$path1 = 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config'
$path2 = 'HKLM:\Software\Microsoft\Cryptography'
$path3 = 'HKLM:\Software\Microsoft\Cryptography\Wintrust'
$path4 = 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography'
$path5 = 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust'
#conditions
	if((test-path $path0) -eq $false -or (test-path $path1) -eq $false){
		if ((test-path $path0) -eq $false) {
			New-Key -Path $path2 -Name Wintrust
			New-Key -Path $path3 -Name Config
			New-RegItem -Path $path0 -Name EnableCertPaddingCheck -PropertyType String -Value 1
		}
		if ((test-path $path1) -eq $false) {
			New-Key -Path $path4 -Name Wintrust
			New-Key -Path $path5 -Name Config
			New-RegItem -Path $path1 -Name EnableCertPaddingCheck -PropertyType String -Value 1
		}
	}
	if((test-path $path0) -eq $true -or (test-path $path1) -eq $true){
		if ((test-path $path0) -eq $true) {
			$eval = get-itemproperty $path0
				if ($null -eq $eval.EnableCertPaddingCheck) { New-RegItem -Path $path0 -Name EnableCertPaddingCheck -PropertyType String -Value 1 }
				else { $tpath0 = $path0.replace(':','')
					   $eval2 = & reg query $tpath0 /v EnableCertPaddingCheck
							if(($eval2 | Select-String REG_SZ).count -eq 1) {
									Set-ItemProperty $path0 -name EnableCertPaddingCheck -Value 1 -ea SilentlyContinue 
							}
							if(($eval2 | Select-String REG_DWORD).count -eq 1) {
									Remove-ItemProperty $path0 -Name EnableCertPaddingCheck -ea SilentlyContinue
									New-RegItem -Path $path0 -Name EnableCertPaddingCheck -PropertyType String -Value 1
							}
				}
		}
		if ((test-path $path1) -eq $true) {
			$eval1 = get-itemproperty $path1
				if ($null -eq $eval1.EnableCertPaddingCheck) {New-RegItem -Path $path0 -Name EnableCertPaddingCheck -PropertyType String -Value 1 }
				else { $tpath1 = $path1.replace(':','')
					   $eval3 = & reg query $tpath1 /v EnableCertPaddingCheck
							if(($eval3 | Select-String REG_SZ).count -eq 1){
									Set-ItemProperty $path1 -name EnableCertPaddingCheck -Value 1 -ea SilentlyContinue 
							}
							if(($eval3 | Select-String REG_DWORD).count -eq 1){
									Remove-ItemProperty $path1 -Name EnableCertPaddingCheck -ea SilentlyContinue
									New-RegItem -Path $path1 -Name EnableCertPaddingCheck -PropertyType String -Value 1
							}
				}
		}
	}
	
