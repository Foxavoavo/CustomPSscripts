<# https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2019-9506 
   https://support.microsoft.com/en-us/topic/windows-guidance-for-bluetooth-key-length-enforcement-1b80c5b9-ddc1-31c7-1c3e-78e07c4fe877
#>
#functions
function New-Key{
	param($Path, $Name)
	New-Item -path $Path -Name $Name -ea SilentlyContinue | Out-Null
}
function New-RegItem{
	param($Path, $Name, $PropertyType,$Value)
	New-ItemProperty -Path $Path -Name $Name -PropertyType $PropertyType -Value $Value -ea SilentlyContinue | Out-null
}
#chk0
$path = 'HKLM:\SYSTEM\CurrentControlSet\Policies\Hardware\Bluetooth'
#conditions
if((test-path $path) -eq $true){
	$eval = get-itemproperty $path
		if($null -eq $eval.EnableMinimumEncryptionKeySize){
			New-RegItem -Path $path -Name EnableMinimumEncryptionKeySize -PropertyType Dword -Value 1
		}
		else{
			Set-ItemProperty -Path $path -Name EnableMinimumEncryptionKeySize -Value 1
		}
}
if((test-path $path) -eq $False){
	#chk1
	$path0 = $path 
	$path1 = $path.replace('\Bluetooth','')
	$path2 = $path.replace('\Hardware\Bluetooth','')
	$path3 = $path.replace('\Policies\Hardware\Bluetooth','')
	#eval
	$eval1 = get-childitem $path1 -ea SilentlyContinue
	$eval2 = get-childitem $path2 -ea SilentlyContinue
	#conditons
	if($null -eq $eval2){
		New-Key -Path $path3 -Name Policies
		New-Key -Path $path2 -Name Hardware
		New-Key -Path $path1 -Name Bluetooth
		New-RegItem -Path $path0 -Name EnableMinimumEncryptionKeySize -PropertyType Dword -Value 1
		Return
	}
	if($null -eq $eval1){
		New-Key -Path $path2 -Name Hardware
		New-Key -Path $path1 -Name Bluetooth
		New-RegItem -Path $path0 -Name EnableMinimumEncryptionKeySize -PropertyType Dword -Value 1
		Return
	}
}
